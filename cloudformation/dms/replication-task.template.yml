AWSTemplateFormatVersion: '2010-09-09'
Description: Create infra for OneeWorld - DMS task 
Parameters:
  DomainName:
    Type: String
    Default: onee.world
    Description: Enter the name domain
  ProjectName:
    Type: String
    Default: oneeworld
    Description: Enter the project name
  StageName:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: 'Enter the environment: dev or prod'
  CnpjDiadema:
    Type: String
    Default: '00164771000114'
    Description: 'Enter the CnpjEmpresa Diadema'
  CnpjPaulinia:
    Type: String
    Default: '26305853000125'
    Description: 'Enter the CnpjEmpresa Diadema'
Conditions:
  IsProduction:
    Fn::Equals:
      - Ref: StageName
      - prod  
Resources:  
  OneebraytonMariadbClientemanCliente:
    Type: AWS::DMS::ReplicationTask
    Properties: 
      ReplicationTaskIdentifier: oneebrayton-mariadb-clienteman-cliente
      ReplicationInstanceArn: 
        Fn::ImportValue:
          !Sub dms-${StageName}-arn-instance
      SourceEndpointArn:
        Fn::ImportValue:
          !Sub dms-${StageName}-arn-endpoint-onee-brayton
      TargetEndpointArn: 
        Fn::ImportValue:
          !Sub dms-${StageName}-arn-endpoint-mariadb
      MigrationType: full-load-and-cdc
      Tags: 
        - Key: Project
          Value:
            Ref: ProjectName
        - Key: Environment
          Value:
            Fn::If:
              - IsProduction
              - Production
              - Development
      ReplicationTaskSettings: |
        {
          "Logging": {
            "EnableLogging": true,
            "LogComponents": [
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TRANSFORMATION"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "SOURCE_UNLOAD"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "IO"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TARGET_LOAD"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "PERFORMANCE"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "SOURCE_CAPTURE"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "SORTER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "REST_SERVER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "VALIDATOR_EXT"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TARGET_APPLY"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TASK_MANAGER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TABLES_MANAGER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "METADATA_MANAGER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "FILE_FACTORY"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "COMMON"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "ADDONS"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "DATA_STRUCTURE"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "COMMUNICATION"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "FILE_TRANSFER"
              }
            ],
            "CloudWatchLogGroup": null,
            "CloudWatchLogStream": null
          },
          "StreamBufferSettings": {
            "StreamBufferCount": 3,
            "CtrlStreamBufferSizeInMB": 5,
            "StreamBufferSizeInMB": 8
          },
          "ErrorBehavior": {
            "FailOnNoTablesCaptured": true,
            "ApplyErrorUpdatePolicy": "LOG_ERROR",
            "FailOnTransactionConsistencyBreached": false,
            "RecoverableErrorThrottlingMax": 1800,
            "DataErrorEscalationPolicy": "SUSPEND_TABLE",
            "ApplyErrorEscalationCount": 0,
            "RecoverableErrorStopRetryAfterThrottlingMax": true,
            "RecoverableErrorThrottling": true,
            "ApplyErrorFailOnTruncationDdl": false,
            "DataTruncationErrorPolicy": "LOG_ERROR",
            "ApplyErrorInsertPolicy": "LOG_ERROR",
            "EventErrorPolicy": "IGNORE",
            "ApplyErrorEscalationPolicy": "LOG_ERROR",
            "RecoverableErrorCount": -1,
            "DataErrorEscalationCount": 0,
            "TableErrorEscalationPolicy": "STOP_TASK",
            "RecoverableErrorInterval": 5,
            "ApplyErrorDeletePolicy": "IGNORE_RECORD",
            "TableErrorEscalationCount": 0,
            "FullLoadIgnoreConflicts": false,
            "DataErrorPolicy": "LOG_ERROR",
            "TableErrorPolicy": "SUSPEND_TABLE"
          },
          "ValidationSettings": {
            "ValidationPartialLobSize": 0,
            "PartitionSize": 10000,
            "RecordFailureDelayLimitInMinutes": 0,
            "SkipLobColumns": false,
            "FailureMaxCount": 10000,
            "HandleCollationDiff": false,
            "ValidationQueryCdcDelaySeconds": 0,
            "ValidationMode": "ROW_LEVEL",
            "TableFailureMaxCount": 1000,
            "RecordFailureDelayInMinutes": 5,
            "MaxKeyColumnSize": 8096,
            "EnableValidation": false,
            "ThreadCount": 5,
            "RecordSuspendDelayInMinutes": 30,
            "ValidationOnly": false
          },
          "TTSettings": {
            "TTS3Settings": null,
            "TTRecordSettings": null,
            "EnableTT": false
          },
          "FullLoadSettings": {
            "CommitRate": 10000,
            "StopTaskCachedChangesApplied": false,
            "StopTaskCachedChangesNotApplied": false,
            "MaxFullLoadSubTasks": 8,
            "TransactionConsistencyTimeout": 600,
            "CreatePkAfterFullLoad": false,
            "TargetTablePrepMode": "DO_NOTHING"
          },
          "TargetMetadata": {
            "ParallelApplyBufferSize": 0,
            "ParallelApplyQueuesPerThread": 0,
            "ParallelApplyThreads": 0,
            "TargetSchema": "",
            "InlineLobMaxSize": 0,
            "ParallelLoadQueuesPerThread": 0,
            "SupportLobs": true,
            "LobChunkSize": 0,
            "TaskRecoveryTableEnabled": false,
            "ParallelLoadThreads": 0,
            "LobMaxSize": 32,
            "BatchApplyEnabled": false,
            "FullLobMode": false,
            "LimitedSizeLobMode": true,
            "LoadMaxFileSize": 0,
            "ParallelLoadBufferSize": 0
          },
          "BeforeImageSettings": null,
          "ControlTablesSettings": {
            "historyTimeslotInMinutes": 5,
            "HistoryTimeslotInMinutes": 5,
            "StatusTableEnabled": false,
            "SuspendedTablesTableEnabled": false,
            "HistoryTableEnabled": false,
            "ControlSchema": "",
            "FullLoadExceptionTableEnabled": false
          },
          "LoopbackPreventionSettings": null,
          "CharacterSetSettings": null,
          "FailTaskWhenCleanTaskResourceFailed": false,
          "ChangeProcessingTuning": {
            "StatementCacheSize": 50,
            "CommitTimeout": 1,
            "BatchApplyPreserveTransaction": true,
            "BatchApplyTimeoutMin": 1,
            "BatchSplitSize": 0,
            "BatchApplyTimeoutMax": 30,
            "MinTransactionSize": 1000,
            "MemoryKeepTime": 60,
            "BatchApplyMemoryLimit": 500,
            "MemoryLimitTotal": 1024
          },
          "ChangeProcessingDdlHandlingPolicy": {
            "HandleSourceTableDropped": true,
            "HandleSourceTableTruncated": true,
            "HandleSourceTableAltered": true
          },
          "PostProcessingRules": null
        }
      TableMappings: 
        !Sub |
          {
            "rules": [
              {
                "rule-action": "include",
                "rule-type": "selection",
                "rule-id": "100",
                "rule-name": "100",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },                  
                "filters": []
              },
              {
                "rule-type": "transformation",
                "rule-id": "200",
                "rule-name": "200",
                "rule-target": "schema",
                "object-locator": {
                  "schema-name": "dbo"
                },
                "rule-action": "rename",
                "value": "cliente"
              },
              {
                "rule-type": "transformation",
                "rule-id": "300",
                "rule-name": "300",
                "rule-target": "table",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "rename",
                "value": "ClienteMigration"
              },
              {
                "rule-type": "transformation",
                "rule-id": "400",
                "rule-name": "400",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "id_cliente"
                },
                "rule-action": "include-column"
              },
              {
                "rule-type": "transformation",
                "rule-id": "401",
                "rule-name": "401",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "id_cliente"
                },
                "rule-action": "rename",
                "value": "Id"
              },
              {
                "rule-type": "transformation",
                "rule-id": "500",
                "rule-name": "500",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "add-column",
                "value": "CnpjEmpresa",
                "data-type": {
                    "type": "string",
                    "length": 255
                },              
                "expression": "'${CnpjDiadema}'"
              },
              {
                "rule-type": "transformation",
                "rule-id": "600",
                "rule-name": "600",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "add-column",
                "value": "IdTipoDocCliente",
                "data-type": {
                    "type": "int4",
                    "precision ": 11
                },              
                "expression": "CASE WHEN $tipo_doc='CNPJ' THEN 1 ELSE 2 END"
              },
              {
                "rule-type": "transformation",
                "rule-id": "700",
                "rule-name": "700",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "n_doc"
                },
                "rule-action": "rename",
                "value": "DocCliente"
              },
              {
                "rule-type": "transformation",
                "rule-id": "800",
                "rule-name": "800",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "razao_social"
                },
                "rule-action": "rename",
                "value": "RazaoSocial"
              },
              {
                "rule-type": "transformation",
                "rule-id": "900",
                "rule-name": "900",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "nome_fantasia"
                },
                "rule-action": "rename",
                "value": "NomeFantasia"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1000",
                "rule-name": "1000",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "im"
                },
                "rule-action": "rename",
                "value": "InscricaoMunicipal"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1100",
                "rule-name": "1100",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "ie"
                },
                "rule-action": "rename",
                "value": "InscricaoEstadual"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1200",
                "rule-name": "1200",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "tel"
                },
                "rule-action": "rename",
                "value": "Telefone"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1300",
                "rule-name": "1300",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "email"
                },
                "rule-action": "rename",
                "value": "Email"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1400",
                "rule-name": "1400",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "bloqueado"
                },
                "rule-action": "rename",
                "value": "Bloqueado"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1500",
                "rule-name": "1500",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "requisitos"
                },
                "rule-action": "rename",
                "value": "Requisitos"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1600",
                "rule-name": "1600",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "add-column",
                "value": "IdPerfilCliente",
                "data-type": {
                    "type": "int4",
                    "precision ": 11
                },              
                "expression": "CASE WHEN $idPerfil=0 THEN null ELSE $idPerfil END"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1700",
                "rule-name": "1700",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "condPagamento"
                },
                "rule-action": "rename",
                "value": "IdCondicaoPagamento"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1800",
                "rule-name": "1800",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "modoPagamento"
                },
                "rule-action": "rename",
                "value": "IdModoPagamento"
              },
              {
                "rule-type": "transformation",
                "rule-id": "9000",
                "rule-name": "9000",
                "rule-action": "define-primary-key",
                "rule-target": "table",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "primary-key-def": {
                  "name": "PRIMARY-KEY",
                  "columns": [
                    "Id",
                    "CnpjEmpresa"
                  ]
                }
              }
            ]
          }
  OneebraytonpauliniaMariadbClientemanCliente:
    Type: AWS::DMS::ReplicationTask
    Properties: 
      ReplicationTaskIdentifier: oneebraytonpaulinia-mariadb-clienteman-cliente
      ReplicationInstanceArn: 
        Fn::ImportValue:
          !Sub dms-${StageName}-arn-instance
      SourceEndpointArn:
        Fn::ImportValue:
          !Sub dms-${StageName}-arn-endpoint-onee-brayton-paulinia
      TargetEndpointArn: 
        Fn::ImportValue:
          !Sub dms-${StageName}-arn-endpoint-mariadb
      MigrationType: full-load-and-cdc
      Tags: 
        - Key: Project
          Value:
            Ref: ProjectName
        - Key: Environment
          Value:
            Fn::If:
              - IsProduction
              - Production
              - Development
      ReplicationTaskSettings: |
        {
          "Logging": {
            "EnableLogging": true,
            "LogComponents": [
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TRANSFORMATION"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "SOURCE_UNLOAD"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "IO"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TARGET_LOAD"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "PERFORMANCE"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "SOURCE_CAPTURE"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "SORTER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "REST_SERVER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "VALIDATOR_EXT"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TARGET_APPLY"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TASK_MANAGER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TABLES_MANAGER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "METADATA_MANAGER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "FILE_FACTORY"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "COMMON"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "ADDONS"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "DATA_STRUCTURE"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "COMMUNICATION"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "FILE_TRANSFER"
              }
            ],
            "CloudWatchLogGroup": null,
            "CloudWatchLogStream": null
          },
          "StreamBufferSettings": {
            "StreamBufferCount": 3,
            "CtrlStreamBufferSizeInMB": 5,
            "StreamBufferSizeInMB": 8
          },
          "ErrorBehavior": {
            "FailOnNoTablesCaptured": true,
            "ApplyErrorUpdatePolicy": "LOG_ERROR",
            "FailOnTransactionConsistencyBreached": false,
            "RecoverableErrorThrottlingMax": 1800,
            "DataErrorEscalationPolicy": "SUSPEND_TABLE",
            "ApplyErrorEscalationCount": 0,
            "RecoverableErrorStopRetryAfterThrottlingMax": true,
            "RecoverableErrorThrottling": true,
            "ApplyErrorFailOnTruncationDdl": false,
            "DataTruncationErrorPolicy": "LOG_ERROR",
            "ApplyErrorInsertPolicy": "LOG_ERROR",
            "EventErrorPolicy": "IGNORE",
            "ApplyErrorEscalationPolicy": "LOG_ERROR",
            "RecoverableErrorCount": -1,
            "DataErrorEscalationCount": 0,
            "TableErrorEscalationPolicy": "STOP_TASK",
            "RecoverableErrorInterval": 5,
            "ApplyErrorDeletePolicy": "IGNORE_RECORD",
            "TableErrorEscalationCount": 0,
            "FullLoadIgnoreConflicts": false,
            "DataErrorPolicy": "LOG_ERROR",
            "TableErrorPolicy": "SUSPEND_TABLE"
          },
          "ValidationSettings": {
            "ValidationPartialLobSize": 0,
            "PartitionSize": 10000,
            "RecordFailureDelayLimitInMinutes": 0,
            "SkipLobColumns": false,
            "FailureMaxCount": 10000,
            "HandleCollationDiff": false,
            "ValidationQueryCdcDelaySeconds": 0,
            "ValidationMode": "ROW_LEVEL",
            "TableFailureMaxCount": 1000,
            "RecordFailureDelayInMinutes": 5,
            "MaxKeyColumnSize": 8096,
            "EnableValidation": false,
            "ThreadCount": 5,
            "RecordSuspendDelayInMinutes": 30,
            "ValidationOnly": false
          },
          "TTSettings": {
            "TTS3Settings": null,
            "TTRecordSettings": null,
            "EnableTT": false
          },
          "FullLoadSettings": {
            "CommitRate": 10000,
            "StopTaskCachedChangesApplied": false,
            "StopTaskCachedChangesNotApplied": false,
            "MaxFullLoadSubTasks": 8,
            "TransactionConsistencyTimeout": 600,
            "CreatePkAfterFullLoad": false,
            "TargetTablePrepMode": "DO_NOTHING"
          },
          "TargetMetadata": {
            "ParallelApplyBufferSize": 0,
            "ParallelApplyQueuesPerThread": 0,
            "ParallelApplyThreads": 0,
            "TargetSchema": "",
            "InlineLobMaxSize": 0,
            "ParallelLoadQueuesPerThread": 0,
            "SupportLobs": true,
            "LobChunkSize": 0,
            "TaskRecoveryTableEnabled": false,
            "ParallelLoadThreads": 0,
            "LobMaxSize": 32,
            "BatchApplyEnabled": false,
            "FullLobMode": false,
            "LimitedSizeLobMode": true,
            "LoadMaxFileSize": 0,
            "ParallelLoadBufferSize": 0
          },
          "BeforeImageSettings": null,
          "ControlTablesSettings": {
            "historyTimeslotInMinutes": 5,
            "HistoryTimeslotInMinutes": 5,
            "StatusTableEnabled": false,
            "SuspendedTablesTableEnabled": false,
            "HistoryTableEnabled": false,
            "ControlSchema": "",
            "FullLoadExceptionTableEnabled": false
          },
          "LoopbackPreventionSettings": null,
          "CharacterSetSettings": null,
          "FailTaskWhenCleanTaskResourceFailed": false,
          "ChangeProcessingTuning": {
            "StatementCacheSize": 50,
            "CommitTimeout": 1,
            "BatchApplyPreserveTransaction": true,
            "BatchApplyTimeoutMin": 1,
            "BatchSplitSize": 0,
            "BatchApplyTimeoutMax": 30,
            "MinTransactionSize": 1000,
            "MemoryKeepTime": 60,
            "BatchApplyMemoryLimit": 500,
            "MemoryLimitTotal": 1024
          },
          "ChangeProcessingDdlHandlingPolicy": {
            "HandleSourceTableDropped": true,
            "HandleSourceTableTruncated": true,
            "HandleSourceTableAltered": true
          },
          "PostProcessingRules": null
        }
      TableMappings: 
        !Sub |
          {
            "rules": [
              {
                "rule-action": "include",
                "rule-type": "selection",
                "rule-id": "100",
                "rule-name": "100",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },                  
                "filters": []
              },
              {
                "rule-type": "transformation",
                "rule-id": "200",
                "rule-name": "200",
                "rule-target": "schema",
                "object-locator": {
                  "schema-name": "dbo"
                },
                "rule-action": "rename",
                "value": "cliente"
              },
              {
                "rule-type": "transformation",
                "rule-id": "300",
                "rule-name": "300",
                "rule-target": "table",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "rename",
                "value": "ClienteMigration"
              },
              {
                "rule-type": "transformation",
                "rule-id": "400",
                "rule-name": "400",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "id_cliente"
                },
                "rule-action": "include-column"
              },
              {
                "rule-type": "transformation",
                "rule-id": "401",
                "rule-name": "401",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "id_cliente"
                },
                "rule-action": "rename",
                "value": "Id"
              },
              {
                "rule-type": "transformation",
                "rule-id": "500",
                "rule-name": "500",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "add-column",
                "value": "CnpjEmpresa",
                "data-type": {
                    "type": "string",
                    "length": 255
                },              
                "expression": "'${CnpjPaulinia}'"
              },
              {
                "rule-type": "transformation",
                "rule-id": "600",
                "rule-name": "600",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "add-column",
                "value": "IdTipoDocCliente",
                "data-type": {
                    "type": "int4",
                    "precision ": 11
                },              
                "expression": "CASE WHEN $tipo_doc='CNPJ' THEN 1 ELSE 2 END"
              },
              {
                "rule-type": "transformation",
                "rule-id": "700",
                "rule-name": "700",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "n_doc"
                },
                "rule-action": "rename",
                "value": "DocCliente"
              },
              {
                "rule-type": "transformation",
                "rule-id": "800",
                "rule-name": "800",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "razao_social"
                },
                "rule-action": "rename",
                "value": "RazaoSocial"
              },
              {
                "rule-type": "transformation",
                "rule-id": "900",
                "rule-name": "900",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "nome_fantasia"
                },
                "rule-action": "rename",
                "value": "NomeFantasia"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1000",
                "rule-name": "1000",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "im"
                },
                "rule-action": "rename",
                "value": "InscricaoMunicipal"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1100",
                "rule-name": "1100",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "ie"
                },
                "rule-action": "rename",
                "value": "InscricaoEstadual"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1200",
                "rule-name": "1200",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "tel"
                },
                "rule-action": "rename",
                "value": "Telefone"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1300",
                "rule-name": "1300",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "email"
                },
                "rule-action": "rename",
                "value": "Email"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1400",
                "rule-name": "1400",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "bloqueado"
                },
                "rule-action": "rename",
                "value": "Bloqueado"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1500",
                "rule-name": "1500",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "requisitos"
                },
                "rule-action": "rename",
                "value": "Requisitos"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1600",
                "rule-name": "1600",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "add-column",
                "value": "IdPerfilCliente",
                "data-type": {
                    "type": "int4",
                    "precision ": 11
                },              
                "expression": "CASE WHEN $idPerfil=0 THEN null ELSE $idPerfil END"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1700",
                "rule-name": "1700",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "condPagamento"
                },
                "rule-action": "rename",
                "value": "IdCondicaoPagamento"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1800",
                "rule-name": "1800",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "modoPagamento"
                },
                "rule-action": "rename",
                "value": "IdModoPagamento"
              },
              {
                "rule-type": "transformation",
                "rule-id": "9000",
                "rule-name": "9000",
                "rule-action": "define-primary-key",
                "rule-target": "table",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "primary-key-def": {
                  "name": "PRIMARY-KEY",
                  "columns": [
                    "Id",
                    "CnpjEmpresa"
                  ]
                }
              }
            ]
          }
  OneebraytonMariadbClientemanClienteEndereco:
    Type: AWS::DMS::ReplicationTask
    Properties: 
      ReplicationTaskIdentifier: oneebrayton-mariadb-clienteman-clienteendereco
      ReplicationInstanceArn: 
        Fn::ImportValue:
          !Sub dms-${StageName}-arn-instance
      SourceEndpointArn:
        Fn::ImportValue:
          !Sub dms-${StageName}-arn-endpoint-onee-brayton
      TargetEndpointArn: 
        Fn::ImportValue:
          !Sub dms-${StageName}-arn-endpoint-mariadb
      MigrationType: full-load-and-cdc
      Tags: 
        - Key: Project
          Value:
            Ref: ProjectName
        - Key: Environment
          Value:
            Fn::If:
              - IsProduction
              - Production
              - Development
      ReplicationTaskSettings: |
        {
          "Logging": {
            "EnableLogging": true,
            "LogComponents": [
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TRANSFORMATION"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "SOURCE_UNLOAD"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "IO"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TARGET_LOAD"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "PERFORMANCE"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "SOURCE_CAPTURE"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "SORTER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "REST_SERVER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "VALIDATOR_EXT"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TARGET_APPLY"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TASK_MANAGER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "TABLES_MANAGER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "METADATA_MANAGER"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "FILE_FACTORY"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "COMMON"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "ADDONS"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "DATA_STRUCTURE"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "COMMUNICATION"
              },
              {
                  "Severity": "LOGGER_SEVERITY_DEFAULT",
                  "Id": "FILE_TRANSFER"
              }
            ],
            "CloudWatchLogGroup": null,
            "CloudWatchLogStream": null
          },
          "StreamBufferSettings": {
            "StreamBufferCount": 3,
            "CtrlStreamBufferSizeInMB": 5,
            "StreamBufferSizeInMB": 8
          },
          "ErrorBehavior": {
            "FailOnNoTablesCaptured": true,
            "ApplyErrorUpdatePolicy": "LOG_ERROR",
            "FailOnTransactionConsistencyBreached": false,
            "RecoverableErrorThrottlingMax": 1800,
            "DataErrorEscalationPolicy": "SUSPEND_TABLE",
            "ApplyErrorEscalationCount": 0,
            "RecoverableErrorStopRetryAfterThrottlingMax": true,
            "RecoverableErrorThrottling": true,
            "ApplyErrorFailOnTruncationDdl": false,
            "DataTruncationErrorPolicy": "LOG_ERROR",
            "ApplyErrorInsertPolicy": "LOG_ERROR",
            "EventErrorPolicy": "IGNORE",
            "ApplyErrorEscalationPolicy": "LOG_ERROR",
            "RecoverableErrorCount": -1,
            "DataErrorEscalationCount": 0,
            "TableErrorEscalationPolicy": "STOP_TASK",
            "RecoverableErrorInterval": 5,
            "ApplyErrorDeletePolicy": "IGNORE_RECORD",
            "TableErrorEscalationCount": 0,
            "FullLoadIgnoreConflicts": false,
            "DataErrorPolicy": "LOG_ERROR",
            "TableErrorPolicy": "SUSPEND_TABLE"
          },
          "ValidationSettings": {
            "ValidationPartialLobSize": 0,
            "PartitionSize": 10000,
            "RecordFailureDelayLimitInMinutes": 0,
            "SkipLobColumns": false,
            "FailureMaxCount": 10000,
            "HandleCollationDiff": false,
            "ValidationQueryCdcDelaySeconds": 0,
            "ValidationMode": "ROW_LEVEL",
            "TableFailureMaxCount": 1000,
            "RecordFailureDelayInMinutes": 5,
            "MaxKeyColumnSize": 8096,
            "EnableValidation": false,
            "ThreadCount": 5,
            "RecordSuspendDelayInMinutes": 30,
            "ValidationOnly": false
          },
          "TTSettings": {
            "TTS3Settings": null,
            "TTRecordSettings": null,
            "EnableTT": false
          },
          "FullLoadSettings": {
            "CommitRate": 10000,
            "StopTaskCachedChangesApplied": false,
            "StopTaskCachedChangesNotApplied": false,
            "MaxFullLoadSubTasks": 8,
            "TransactionConsistencyTimeout": 600,
            "CreatePkAfterFullLoad": false,
            "TargetTablePrepMode": "DO_NOTHING"
          },
          "TargetMetadata": {
            "ParallelApplyBufferSize": 0,
            "ParallelApplyQueuesPerThread": 0,
            "ParallelApplyThreads": 0,
            "TargetSchema": "",
            "InlineLobMaxSize": 0,
            "ParallelLoadQueuesPerThread": 0,
            "SupportLobs": true,
            "LobChunkSize": 0,
            "TaskRecoveryTableEnabled": false,
            "ParallelLoadThreads": 0,
            "LobMaxSize": 32,
            "BatchApplyEnabled": false,
            "FullLobMode": false,
            "LimitedSizeLobMode": true,
            "LoadMaxFileSize": 0,
            "ParallelLoadBufferSize": 0
          },
          "BeforeImageSettings": null,
          "ControlTablesSettings": {
            "historyTimeslotInMinutes": 5,
            "HistoryTimeslotInMinutes": 5,
            "StatusTableEnabled": false,
            "SuspendedTablesTableEnabled": false,
            "HistoryTableEnabled": false,
            "ControlSchema": "",
            "FullLoadExceptionTableEnabled": false
          },
          "LoopbackPreventionSettings": null,
          "CharacterSetSettings": null,
          "FailTaskWhenCleanTaskResourceFailed": false,
          "ChangeProcessingTuning": {
            "StatementCacheSize": 50,
            "CommitTimeout": 1,
            "BatchApplyPreserveTransaction": true,
            "BatchApplyTimeoutMin": 1,
            "BatchSplitSize": 0,
            "BatchApplyTimeoutMax": 30,
            "MinTransactionSize": 1000,
            "MemoryKeepTime": 60,
            "BatchApplyMemoryLimit": 500,
            "MemoryLimitTotal": 1024
          },
          "ChangeProcessingDdlHandlingPolicy": {
            "HandleSourceTableDropped": true,
            "HandleSourceTableTruncated": true,
            "HandleSourceTableAltered": true
          },
          "PostProcessingRules": null
        }
      TableMappings: 
        !Sub |
          {
            "rules": [
              {
                "rule-action": "include",
                "rule-type": "selection",
                "rule-id": "100",
                "rule-name": "100",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },                  
                "filters": []
              },
              {
                "rule-type": "transformation",
                "rule-id": "200",
                "rule-name": "200",
                "rule-target": "schema",
                "object-locator": {
                  "schema-name": "dbo"
                },
                "rule-action": "rename",
                "value": "cliente"
              },
              {
                "rule-type": "transformation",
                "rule-id": "300",
                "rule-name": "300",
                "rule-target": "table",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "rename",
                "value": "ClienteEnderecoMigration"
              },
              {
                "rule-type": "transformation",
                "rule-id": "400",
                "rule-name": "400",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "n_doc"
                },
                "rule-action": "include-column"
              },
              {
                "rule-type": "transformation",
                "rule-id": "401",
                "rule-name": "401",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "n_doc"
                },
                "rule-action": "rename",
                "value": "DocClienteEndereco"
              },
              {
                "rule-type": "transformation",
                "rule-id": "500",
                "rule-name": "500",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "add-column",
                "value": "IdTipoDocClienteEndereco",
                "data-type": {
                    "type": "int4",
                    "precision": 11
                },              
                "expression": "CASE WHEN $tipo_doc='CNPJ' THEN 1 ELSE 2 END"
              },
              {
                "rule-type": "transformation",
                "rule-id": "600",
                "rule-name": "600",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "id_cliente"
                },
                "rule-action": "rename",
                "value": "IdCliente"
              },
              {
                "rule-type": "transformation",
                "rule-id": "700",
                "rule-name": "700",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "add-column",
                "value": "CnpjEmpresa",
                "data-type": {
                    "type": "string",
                    "length": 255
                },              
                "expression": "'${CnpjDiadema}'"
              },
              {
                "rule-type": "transformation",
                "rule-id": "800",
                "rule-name": "800",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "rule-action": "add-column",
                "value": "IdTipoEnderecoCliente",
                "data-type": {
                    "type": "int4",
                    "precision": 1
                },              
                "expression": "1"
              },
              {
                "rule-type": "transformation",
                "rule-id": "900",
                "rule-name": "900",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "nome_fantasia"
                },
                "rule-action": "rename",
                "value": "Descricao"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1000",
                "rule-name": "1000",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "endereco"
                },
                "rule-action": "rename",
                "value": "Endereco"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1100",
                "rule-name": "1100",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "numero"
                },
                "rule-action": "rename",
                "value": "Numero"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1200",
                "rule-name": "1200",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "endComplemento"
                },
                "rule-action": "rename",
                "value": "Complemento"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1300",
                "rule-name": "1300",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "bairro"
                },
                "rule-action": "rename",
                "value": "Bairro"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1400",
                "rule-name": "1400",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "cep"
                },
                "rule-action": "rename",
                "value": "Cep"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1500",
                "rule-name": "1500",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "cidade"
                },
                "rule-action": "rename",
                "value": "IdCidade"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1600",
                "rule-name": "1600",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "estado"
                },
                "rule-action": "rename",
                "value": "IdEstado"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1700",
                "rule-name": "1700",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "pais"
                },
                "rule-action": "rename",
                "value": "IdPais"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1800",
                "rule-name": "1800",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "im"
                },
                "rule-action": "rename",
                "value": "InscricaoMunicipal"
              },
              {
                "rule-type": "transformation",
                "rule-id": "1900",
                "rule-name": "1900",
                "rule-target": "column",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man",
                  "column-name": "ie"
                },
                "rule-action": "rename",
                "value": "InscricaoEstadual"
              },
              {
                "rule-type": "transformation",
                "rule-id": "9000",
                "rule-name": "9000",
                "rule-action": "define-primary-key",
                "rule-target": "table",
                "object-locator": {
                  "schema-name": "dbo",
                  "table-name": "Cliente_man"
                },
                "primary-key-def": {
                  "name": "PRIMARY-KEY",
                  "columns": [
                    "Id"
                  ]
                }
              }
            ]
          }